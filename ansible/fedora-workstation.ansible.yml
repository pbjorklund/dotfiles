---
- name: Setup Fedora Workstation
  hosts: localhost
  connection: local
  become: true
  vars:
    user_home: "{{ ansible_env.HOME }}"
    regular_user: "{{ ansible_env.USER }}"
    original_user: "{{ ansible_env.SUDO_USER }}"

  tasks:
    - name: Import 1Password GPG key
      ansible.builtin.rpm_key:
        key: https://downloads.1password.com/linux/keys/1password.asc
        state: present

    - name: Add 1Password repository
      ansible.builtin.yum_repository:
        name: 1password
        description: 1Password Stable Channel
        baseurl: https://downloads.1password.com/linux/rpm/stable/$basearch
        enabled: true
        gpgcheck: true
        repo_gpgcheck: true
        gpgkey: https://downloads.1password.com/linux/keys/1password.asc

    - name: Add Google Chrome repository
      ansible.builtin.yum_repository:
        name: google-chrome
        description: Google Chrome
        baseurl: http://dl.google.com/linux/chrome/rpm/stable/x86_64
        enabled: true
        gpgcheck: true
        gpgkey: https://dl.google.com/linux/linux_signing_key.pub

    - name: Import Google Chrome GPG key
      ansible.builtin.rpm_key:
        key: https://dl.google.com/linux/linux_signing_key.pub
        state: present

    - name: Import Microsoft GPG key
      ansible.builtin.rpm_key:
        key: https://packages.microsoft.com/keys/microsoft.asc
        state: present

    - name: Add Visual Studio Code repository
      ansible.builtin.yum_repository:
        name: vscode
        description: Visual Studio Code
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        enabled: true
        gpgcheck: true
        gpgkey: https://packages.microsoft.com/keys/microsoft.asc

    - name: Install desktop applications (native packages for integration)
      ansible.builtin.dnf:
        name:
          - 1password  # Password manager (needs system integration)
          - google-chrome-stable  # Web browser (needs system integration)
          - code  # Visual Studio Code (needs system integration)
        state: present

    - name: Install teams-for-linux via Flatpak (unofficial Teams client)
      community.general.flatpak:
        name: com.github.IsmaelMartinez.teams_for_linux
        state: present
      become: true
      become_user: "{{ original_user }}"

    - name: Install development tools
      ansible.builtin.dnf:
        name:
          - git  # Version control
          - vim  # Text editor
          - neovim  # Modern vim
          - tmux  # Terminal multiplexer
          - nodejs  # JavaScript runtime
          - npm  # Node package manager
          - python3-pip  # Python package manager
          - python3-psutil  # Python system utilities (required for dconf)
          - ansible  # Automation tool
          - ansible-lint  # Ansible linting
          - yamllint  # YAML linting
          - openssh-clients  # SSH tools (includes ssh-keygen)
          - gh  # GitHub CLI
        state: present

    - name: Install command line utilities
      ansible.builtin.dnf:
        name:
          - curl  # HTTP client
          - wget  # File downloader
          - jq  # JSON processor
          - tree  # Directory structure viewer
          - htop  # Process monitor
          - ripgrep  # Fast grep alternative
          - fd-find  # Fast find alternative
          - bat  # Cat with syntax highlighting
          - fzf  # Fuzzy finder
          - zsh  # Alternative shell
          - unzip  # Archive extraction
        state: present

    - name: Install GNOME desktop utilities
      ansible.builtin.dnf:
        name:
          - gnome-shell-extension-dash-to-dock  # Dash to Dock extension
        state: present

    - name: Install containerization tools
      ansible.builtin.dnf:
        name:
          - docker  # Container runtime (includes compose)
        state: present

    - name: Remove Firefox
      ansible.builtin.dnf:
        name: firefox
        state: absent

    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: present
        update_only: true

    - name: Check if dotfiles directory exists
      ansible.builtin.stat:
        path: "/home/{{ original_user }}/dotfiles"
      register: dotfiles_dir
      become: true
      become_user: "{{ original_user }}"

    - name: Clone repo from GitHub to user home (as regular user)
      ansible.builtin.git:
        repo: https://github.com/pbjorklund/dotfiles.git
        dest: "/home/{{ original_user }}/dotfiles"
        version: master
        update: false
      become: true
      become_user: "{{ original_user }}"
      when: not dotfiles_dir.stat.exists


    - name: Run dotfiles install script to create symlinks
      ansible.builtin.command:
        cmd: ./install.sh
        chdir: "/home/{{ original_user }}/dotfiles"
      become: true
      become_user: "{{ original_user }}"
      register: install_result
      changed_when: "'Creating symlink' in install_result.stdout"

    - name: Start and enable Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ original_user }}"
        groups: docker
        append: true

    - name: Check if SSH key exists
      ansible.builtin.stat:
        path: "/home/{{ original_user }}/.ssh/id_ed25519"
      register: ssh_key_check
      become: true
      become_user: "{{ original_user }}"

    - name: Generate SSH key pair
      ansible.builtin.command:
        cmd: >-
          ssh-keygen -t ed25519 -f /home/{{ original_user }}/.ssh/id_ed25519
          -N "" -C "{{ original_user }}@{{ ansible_hostname }}"
      become: true
      become_user: "{{ original_user }}"
      when: not ssh_key_check.stat.exists
      changed_when: true

    - name: Set SSH key permissions
      ansible.builtin.file:
        path: "/home/{{ original_user }}/.ssh"
        state: directory
        mode: "0700"
        owner: "{{ original_user }}"
        group: "{{ original_user }}"
      become: true

    - name: Set private key permissions
      ansible.builtin.file:
        path: "/home/{{ original_user }}/.ssh/id_ed25519"
        mode: "0600"
        owner: "{{ original_user }}"
        group: "{{ original_user }}"
      become: true
      when: not ssh_key_check.stat.exists

    - name: Set public key permissions
      ansible.builtin.file:
        path: "/home/{{ original_user }}/.ssh/id_ed25519.pub"
        mode: "0644"
        owner: "{{ original_user }}"
        group: "{{ original_user }}"
      become: true
      when: not ssh_key_check.stat.exists

    - name: Display SSH public key
      ansible.builtin.command:
        cmd: cat /home/{{ original_user }}/.ssh/id_ed25519.pub
      register: ssh_public_key
      become: true
      become_user: "{{ original_user }}"
      when: not ssh_key_check.stat.exists
      changed_when: false

    - name: Show SSH public key for GitHub
      ansible.builtin.debug:
        msg: |
          SSH key generated successfully!
          Add this public key to your GitHub account:
          {{ ssh_public_key.stdout }}
      when: not ssh_key_check.stat.exists

    - name: Enable focus-on-hover in GNOME
      community.general.dconf:
        key: "/org/gnome/desktop/wm/preferences/focus-mode"
        value: "'sloppy'"
      become: true
      become_user: "{{ original_user }}"

    - name: Enable Dash to Dock extension
      community.general.dconf:
        key: "/org/gnome/shell/enabled-extensions"
        value: "['dash-to-dock@micxgx.gmail.com']"
      become: true
      become_user: "{{ original_user }}"
